```{r}
#| label: fig1
#| fig-width: 9
#| fig-height: 4.75
#| echo: false
#| warning: false
#| message: false
#| fig.cap: > 
#|   Authorship types across time

source(here("scripts","load_gender_data.R"))
library(ggplot2,quietly = TRUE)
library(RColorBrewer)


#### Classify order: Single author ----------
df$authortype <- 'Other'
df$authortype[df$author_order == 1] <- 'Other'
df$authortype[df$author_last == 1] <- 'Other'
df$authortype[df$author_single == 1] <- 'Single' # FOCUS
# Explicit order of the rows and columns!
t <- table(
  factor(df$authortype, levels = c("Single", "Other")),
  factor(df$Gender,levels = c("female","male"))
)

or1 <- effectsize::oddsratio(t) # 0.90
#print(or1)

#### Classify order: First author ----------
df$authortype <- 'Other'
df$authortype[df$author_order == 1] <- 'First'
df$authortype[df$author_last == 1] <- 'Other'
df$authortype[df$author_single == 1] <- 'Other' # Take out single authors from first authors!
# t<-table(df$authortype,df$Gender)
# t
# Explicit order of the rows and columns!
t <- table(
  factor(df$authortype, levels = c("First", "Other")),
  factor(df$Gender,levels = c("female","male"))
)
or2 <- effectsize::oddsratio(t) # 1.41
#print(or2)

#### Classify order: Coauthor --------------
df$authortype <- 'Coauthor'
df$authortype[df$author_order == 1] <- 'Other'
df$authortype[df$author_last == 1] <- 'Other'
df$authortype[df$author_single == 1] <- 'Other' # Take out single authors from first authors!
# Explicit order of the rows and columns!
t <- table(
  factor(df$authortype, levels = c("Coauthor", "Other")),
  factor(df$Gender,levels = c("female","male"))
)

or3 <- effectsize::oddsratio(t) # 1.00
#print(or3)

#### Classify order: Last -------------
df$authortype <- 'Other'
df$authortype[df$author_order == 1] <- 'Other'
df$authortype[df$author_last == 1] <- 'Last'
df$authortype[df$author_single == 1] <- 'Other' # Take out single authors from first authors!
t <- table(
  factor(df$authortype, levels = c("Last", "Other")),
  factor(df$Gender,levels = c("female","male"))
)

or4 <- effectsize::oddsratio(t) # 0.73
#print(or4)

or <- rbind(or1,or2,or3,or4)
or$name<-c("Single","First","Coauthor","Last")
#_or<-dplyr::select(or,name,Odds_ratio,CI_low,CI_high)
#_print(knitr::kable(or,digits = 2))

#### Annually ---------

# introduce 5 year bins
df$YEAR_5 <- cut(df$YEAR, breaks=seq(2000, 2025, by=5), labels=c("2000-2004", "2005-2009", "2010-2014", "2015-2019", "2020-2024"), right=FALSE)
#table(df$YEAR,df$YEAR_5)
#table(df$YEAR_5)

#### Classify order: Single author ----------
df$authortype <- 'Other'
df$authortype[df$author_order == 1] <- 'Other'
df$authortype[df$author_last == 1] <- 'Other'
df$authortype[df$author_single == 1] <- 'Single' # FOCUS

output <- NULL
U<-levels(df$YEAR_5)
for (k in 1:length(U)){
  tmp<-dplyr::filter(df,YEAR_5==U[k])
  t <- table(
    factor(tmp$authortype, levels = c("Single", "Other")),
    factor(tmp$Gender,levels = c("female","male"))
  )
  output <- rbind(output,effectsize::oddsratio(t))
}
output$YearRange <- U
single <- data.frame(output)
#single

#### Classify order: First author ----------
df$authortype <- 'Other'
df$authortype[df$author_order == 1] <- 'First'
df$authortype[df$author_last == 1] <- 'Other'
df$authortype[df$author_single == 1] <- 'Other' # Take out single authors from first authors!

output <- NULL
U<-levels(df$YEAR_5)
for (k in 1:length(U)){
  tmp<-dplyr::filter(df,YEAR_5==U[k])
  t <- table(
    factor(tmp$authortype, levels = c("First", "Other")),
    factor(tmp$Gender,levels = c("female","male"))
  )
  output <- rbind(output,effectsize::oddsratio(t))
}
output$YearRange <- U
first <- data.frame(output)
#first

#### Classify order: Coauthor --------------
df$authortype <- 'Coauthor'
df$authortype[df$author_order == 1] <- 'Other'
df$authortype[df$author_last == 1] <- 'Other'
df$authortype[df$author_single == 1] <- 'Other' # Take out single authors from first authors!

U<-levels(df$YEAR_5)
output <- NULL
for (k in 1:length(U)){
  tmp<-dplyr::filter(df,YEAR_5==U[k])
  t <- table(
    factor(tmp$authortype, levels = c("Coauthor", "Other")),
    factor(tmp$Gender,levels = c("female","male"))
  )
  output <- rbind(output,effectsize::oddsratio(t))
}
output$YearRange <- U
coauthor <- data.frame(output)
#coauthor

#### Classify order: Last -------------
df$authortype <- 'Other'
df$authortype[df$author_order == 1] <- 'Other'
df$authortype[df$author_last == 1] <- 'Last'
df$authortype[df$author_single == 1] <- 'Other' # Take out single authors from first authors!

U<-levels(df$YEAR_5)
output <- NULL
for (k in 1:length(U)){
  tmp<-dplyr::filter(df,YEAR_5==U[k])
  t <- table(
    factor(tmp$authortype, levels = c("Last", "Other")),
    factor(tmp$Gender,levels = c("female","male"))
  )
  output <- rbind(output,effectsize::oddsratio(t))
}
output$YearRange <- U
last <- data.frame(output)

single$Type<-'Single'
first$Type<-'First'
coauthor$Type<-'Co'
last$Type<-'Last'

annual<-rbind(single,first,coauthor,last)
annual$Type = factor(annual$Type, levels = c('Single','First','Co', 'Last'))
#annual

# Create a new facet variable that group INCREASE / DECREASE of OR 
#annual <- annual %>%
#  mutate(TypeGroup = case_when(Type %in% c("Co", "Last") ~ "Co and Last",TRUE ~ Type))
#annual$TypeGroup = as.factor(annual$TypeGroup)
#annual$TypeGroup = factor(annual$TypeGroup, levels = c( "First" ,"Co and Last"))

# add overall
or$name = factor(or$name, levels = c('Single','First','Coauthor', 'Last'), labels = c('Single','First','Co', 'Last'))

tmp <- data.frame(Odds_ratio = or$Odds_ratio, CI=0.95,CI_low = or$CI_low, CI_high = or$CI_high, YearRange = "Overall", Type = or$name)
annual2<- rbind(tmp,annual)
annual2$separator<-"Yearly"
annual2$separator[annual2$YearRange=="Overall"]<-"Overall"
annual2$YearRange <- factor(annual2$YearRange, levels = c("Overall", "2000-2004", "2005-2009", "2010-2014", "2015-2019", "2020-2024"))

custom_palette <- brewer.pal(n = 4, name = "Set1")
custom_palette<-c(custom_palette[4],custom_palette[1:3])

#annual2$Type[1:4]<-NA
annual3<-dplyr::filter(annual2,YearRange!="Overall")
#annual3<-annual2
#annual3$Type[1:4]<-NA

fig1 <- ggplot(annual2,aes(x=YearRange,y=Odds_ratio,color=Type,group=Type,shape=separator))+
  #facet_wrap(~TypeGroup,nrow = 2)+
  geom_hline(yintercept=1, linetype="dashed", color = "black") +
  geom_point(position = position_dodge(width = 0.4),show.legend=TRUE,size=3)+
  geom_errorbar(aes(ymin=CI_low,ymax=CI_high),width=0.2,position = position_dodge(width = 0.4))+
  geom_line(data=annual3,aes(x=YearRange,y=Odds_ratio,color=Type,group=Type,shape=separator),alpha = 0.75,position = position_dodge(width = 0.4))+
  scale_shape_manual(name="Authorship\ntype",values = c(22, 16),guide = "none") +
  scale_color_manual(name="Authorship\ntype",values=custom_palette) +
  xlab('Year range')+
  ylab('Female Authorship Odds Ratio (95%CI)')+
  theme_classic(base_size = 15)
print(fig1)

```
